{% extends "sidebar.html" %}{% block content %}
<div class="d-flex align-items-center gap-3 mb-3">
  <h4 class="mb-0">{{ proceso.nombre }}</h4>
  {% if areas_proc and areas_proc|length>0 %}
    <div class="d-flex flex-wrap gap-1">
      {% for a in areas_proc %}<span class="badge text-bg-info">{{ a.nombre }}</span>{% endfor %}
    </div>
  {% endif %}
  <div class="ms-auto">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin_procesos') }}">Volver a lista</a>
  </div>
</div>

<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-comp">Componentes</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-op">Operaciones</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-desc">Descripción</button></li>
</ul>

<div class="tab-content pt-3">

  <!-- Componentes -->
  <div class="tab-pane fade show active" id="tab-comp">
    <form method="post" class="row g-2 mb-2">
      <input type="hidden" name="accion" value="add_insumo">
      <div class="col-md-5">
        <select name="mercancia_id" class="form-select form-select-sm" required>
          <option value="">Mercancía</option>
          {% for m in mercancias %}<option value="{{ m.id }}">{{ m.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2"><input name="unidad" class="form-control form-control-sm" placeholder="UDM"></div>
      <!-- solo 2 decimales -->
      <div class="col-md-2"><input type="number" step="0.01" min="0" name="cantidad" class="form-control form-control-sm" placeholder="Cant." required></div>
      <div class="col-md-2"><input type="number" step="0.01" min="0" name="merma_pct" class="form-control form-control-sm" placeholder="% merma"></div>
      <div class="col-md-1"><button class="btn btn-sm btn-primary w-100">+</button></div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead><tr><th>Mercancía</th><th class="text-end">Cant.</th><th>UDM</th><th class="text-end">Costo ref</th><th class="text-end">Subtotal</th><th></th></tr></thead>
        <tbody>
        {% set total = 0 %}
        {% for it in componentes %}
          {% set costo = (it.costo_ref or 0) %}
          {% set sub = (it.cantidad or 0) * costo %}
          {% set total = total + sub %}
          <tr>
            <td>{{ it.mercancia }}</td>
            <!-- imprime cantidad con 2 decimales -->
            <td class="text-end">{{ '%.2f'|format((it.cantidad or 0)|float) }}</td>
            <td>{{ it.unidad or '—' }}</td>
            <td class="text-end">{{ '%.2f'|format((costo or 0)|float) }}</td>
            <td class="text-end">{{ '%.2f'|format((sub or 0)|float) }}</td>
            <td class="text-end">
              <form method="post" onsubmit="return confirm('Eliminar insumo?')">
                <input type="hidden" name="accion" value="del_insumo">
                <input type="hidden" name="item_id" value="{{ it.id }}">
                <button class="btn btn-sm btn-outline-danger">×</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
        <tfoot><tr><th colspan="4" class="text-end">Total estimado</th><th class="text-end">{{ '%.2f'|format((total or 0)|float) }}</th><th></th></tr></tfoot>
      </table>
    </div>
  </div>

  <!-- Operaciones -->
  <div class="tab-pane fade" id="tab-op">
    <form method="post" class="row g-2 mb-3">
      <input type="hidden" name="accion" value="add_operacion">
      <div class="col-1"><input type="number" min="1" name="orden" class="form-control form-control-sm" placeholder="#"></div>
      <div class="col-2">
        <select name="area_id" class="form-select form-select-sm" required>
          <option value="">Área</option>
          {% for a in areas %}<option value="{{ a.id }}">{{ a.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-3"><input name="nombre" class="form-control form-control-sm" placeholder="Operación"></div>
      <div class="col-2"><input type="number" min="0" name="duracion_minutos" class="form-control form-control-sm" placeholder="Min."></div>
      <div class="col-2">
        <select name="depende_de" class="form-select form-select-sm">
          <option value="">Sin dependencia</option>
          {% for op in operaciones %}<option value="{{ op.id }}">#{{ op.orden }} {{ op.nombre }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-2"><button class="btn btn-sm btn-primary w-100">Agregar</button></div>
      <div class="col-12"><textarea name="instrucciones" class="form-control" rows="2" placeholder="Instrucciones"></textarea></div>
      <div class="col-12"><input name="descripcion" class="form-control form-control-sm" placeholder="Descripción breve"></div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle" id="ops-table">
        <thead><tr>
          <th style="width:2rem">⇅</th><th>#</th><th>Área</th><th>Operación</th><th>Duración</th><th>Depende de</th><th>Checklist</th><th></th>
        </tr></thead>
        <tbody>
        {% for op in operaciones %}
          <tr data-id="{{ op.id }}">
            <td class="handle">⋮⋮</td>
            <td>{{ op.orden }}</td>
            <td>{{ op.area }}</td>
            <td>
              <div class="fw-semibold">{{ op.nombre }}</div>
              {% if op.instrucciones %}<div class="text-muted small">{{ op.instrucciones }}</div>{% endif %}
            </td>
            <td class="text-end">{{ op.duracion_minutos }} min</td>
            <td>{% if op.depende_de %}#{{ op.depende_de }} {{ op.depende_de_nombre }}{% else %}—{% endif %}</td>
            <td style="min-width:240px">
              <ul class="list-unstyled mb-2">
                {% for c in checklist if c.etapa_id == op.id %}
                <li>
                  <form class="d-inline" method="post" action="{{ url_for('admin_checklist_toggle') }}" onsubmit="return toggleChecklist(event,this)">
                    <input type="hidden" name="check_id" value="{{ c.id }}">
                    <button class="btn btn-sm {{ 'btn-success' if c.done else 'btn-outline-secondary' }}">{{ '✓' if c.done else '○' }}</button>
                  </form>
                  <span class="{{ 'text-decoration-line-through text-muted' if c.done else '' }}">{{ c.texto }}</span>
                </li>
                {% endfor %}
              </ul>
              <form method="post" class="d-flex gap-2">
                <input type="hidden" name="accion" value="add_check">
                <input type="hidden" name="etapa_id" value="{{ op.id }}">
                <input name="texto" class="form-control form-control-sm" placeholder="Nuevo ítem">
                <button class="btn btn-sm btn-outline-primary">+</button>
              </form>
            </td>
            <td class="text-end">
              <form method="post" onsubmit="return confirm('Eliminar operación?')">
                <input type="hidden" name="accion" value="del_operacion">
                <input type="hidden" name="etapa_id" value="{{ op.id }}">
                <button class="btn btn-sm btn-outline-danger">×</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="text-muted small">Arrastra con “⇅” y suelta para reordenar.</div>
  </div>

  <!-- Descripción -->
  <div class="tab-pane fade" id="tab-desc">
    <textarea class="form-control" rows="8" readonly>{{ proceso.descripcion or "" }}</textarea>
  </div>

</div>

<style>
  .handle{ cursor:grab }
  textarea[readonly]{ background:#f8f9fa }
</style>
<script>
function toggleChecklist(ev, form){
  ev.preventDefault();
  fetch(form.action,{method:'POST', body:new FormData(form)}).then(()=>location.reload());
  return false;
}
(function(){
  const tbody = document.querySelector('#ops-table tbody');
  let dragging;
  tbody.addEventListener('dragstart', e=>{
    if(e.target.closest('tr')){ dragging = e.target.closest('tr'); e.dataTransfer.setData('text/plain',''); }
  });
  tbody.addEventListener('dragover', e=>{
    e.preventDefault();
    const row = e.target.closest('tr'); if(!row || row===dragging) return;
    const rect = row.getBoundingClientRect();
    const next = (e.clientY - rect.top) / (rect.height) > .5;
    tbody.insertBefore(dragging, next ? row.nextSibling : row);
  });
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    tr.draggable = true;
    tr.querySelector('.handle').addEventListener('mousedown', ()=>{ tr.draggable = true; });
  });
  window.addEventListener('mouseup', ()=>{
    const pares = [...tbody.querySelectorAll('tr')].map((tr,idx)=>({id: tr.dataset.id, orden: idx+1}));
    fetch('{{ url_for("admin_operaciones_reordenar") }}',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({pares})
    });
  });
})();
</script>
{% endblock %}
