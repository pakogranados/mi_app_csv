{% extends "sidebar.html" %}
{% block content %}
<div class="container mt-4">
  <h3>Proceso de producción: {{ pt.nombre }}</h3>

  <form method="post" class="mb-3">
    <div class="row g-2">
      <div class="col-md-4"><input name="nombre" class="form-control" placeholder="Nombre del proceso"
           value="{{ proceso.nombre if proceso else '' }}" required></div>
      <div class="col-md-6"><input name="descripcion" class="form-control" placeholder="Descripción"
           value="{{ proceso.descripcion if proceso else '' }}"></div>
      <div class="col-md-2"><button class="btn btn-success w-100" type="submit">Guardar</button></div>
    </div>
  </form>

  {% if proceso %}
  <hr>
  <h5>Pasos</h5>
  <form method="post" action="{{ url_for('recetas_paso_agregar', pt_id=pt.id) }}" class="row g-2 mb-3">
    <div class="col-md-4"><input name="nombre" class="form-control" placeholder="Nombre del paso" required></div>
    <div class="col-md-3">
      <select name="area_id" class="form-select">
        <option value="">— Área —</option>
        {% for a in areas %}<option value="{{ a.id }}">{{ a.nombre }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-md-2"><input name="minutos_estimados" type="number" min="0" class="form-control" placeholder="Minutos"></div>
    <div class="col-md-2">
      <select name="requiere_validez" class="form-select">
        <option value="1" selected>Requiere validez</option>
        <option value="0">No requiere</option>
      </select>
    </div>
    <div class="col-md-1"><button class="btn btn-primary w-100">Añadir</button></div>
  </form>

  <div class="accordion" id="acc">
    {% for p in pasos %}
    <div class="accordion-item">
      <h2 class="accordion-header" id="h{{p.id}}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c{{p.id}}">
          {{ p.orden }}. {{ p.nombre }} — {{ p.area_nombre or 'Sin área' }} {% if p.requiere_validez %}(con validación){% endif %}
        </button>
      </h2>
      <div id="c{{p.id}}" class="accordion-collapse collapse" data-bs-parent="#acc">
        <div class="accordion-body">
          <form class="row g-2 mb-2" method="post" action="{{ url_for('recetas_paso_insumo_agregar', paso_id=p.id) }}">
            <div class="col-md-5">
              <select name="mp_id" class="form-select" required>
                <option value="">— MP —</option>
                {% for mp in mps %}<option value="{{ mp.id }}">{{ mp.nombre }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-3"><input name="cantidad_por_lote" type="number" step="0.001" min="0" class="form-control" placeholder="Cantidad" required></div>
            <div class="col-md-3">
              <select name="unidad_id" class="form-select">
                <option value="">— Unidad —</option>
                {% for u in ums %}<option value="{{ u.id }}">{{ u.nombre }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-1"><button class="btn btn-outline-primary w-100">Agregar</button></div>
          </form>

          <table class="table table-sm">
            <thead><tr><th>MP</th><th class="text-end">Cantidad</th><th>Unidad</th></tr></thead>
            <tbody>
              {% for ins in p.insumos %}
              <tr><td>{{ ins.mp_nombre }}</td><td class="text-end">{{ '%.3f'|format(ins.cantidad_por_lote) }}</td><td>{{ ins.unidad or '' }}</td></tr>
              {% else %}<tr><td colspan="3" class="text-muted text-center">Sin insumos</td></tr>{% endfor %}
            </tbody>
          </table>

          <form method="post" action="{{ url_for('recetas_paso_eliminar', paso_id=p.id) }}"
                onsubmit="return confirm('¿Eliminar paso?')">
            <button class="btn btn-outline-danger btn-sm">Eliminar paso</button>
          </form>
        </div>
      </div>
    </div>
    {% else %}
      <div class="text-muted">Aún no hay pasos.</div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}
