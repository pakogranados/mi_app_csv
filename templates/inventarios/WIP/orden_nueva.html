{% extends "sidebar.html" %}
{% block title %}Nueva Orden de Producción{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h3 class="mb-4">Nueva Orden de Producción</h3>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="POST">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="fecha" class="form-label">Fecha *</label>
            <input type="date" class="form-control" id="fecha" name="fecha" 
                   value="{{ fecha_hoy }}" required>
          </div>

          <div class="col-md-8">
            <label for="pt_id" class="form-label">Producto Terminado *</label>
            <select class="form-select" id="pt_id" name="pt_id" required>
              <option value="">-- Selecciona un producto --</option>
              {% for p in productos %}
                <option value="{{ p.id }}" 
                        {% if p.tiene_proceso == 0 %}disabled{% endif %}>
                  {{ p.nombre }}
                  {% if p.tiene_proceso == 0 %}(⚠️ Sin proceso configurado){% endif %}
                </option>
              {% endfor %}
            </select>
            <small class="text-muted">
              Solo se muestran productos con proceso de producción configurado
            </small>
          </div>

          <div class="col-md-6">
            <label for="cantidad" class="form-label">Cantidad a producir *</label>
            <input type="number" step="0.01" class="form-control" id="cantidad" 
                   name="cantidad" min="0.01" required>
          </div>

          <div class="col-md-6">
            <label for="referencia" class="form-label">Referencia (opcional)</label>
            <input type="text" class="form-control" id="referencia" name="referencia" 
                   placeholder="Ej: LOTE-2025-001">
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i> Crear Orden
          </button>
          <a href="{{ url_for('wip.ordenes_list') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>

  <div class="alert alert-info mt-4">
    <i class="fas fa-info-circle"></i>
    <strong>Nota:</strong> Si no ves tu producto en la lista, primero debes 
    <a href="{{ url_for('wip.procesos_list') }}">configurar su proceso de producción</a>.
  </div>
</div>

<script>
  // Establecer fecha de hoy por defecto
  document.addEventListener('DOMContentLoaded', () => {
    const fechaInput = document.getElementById('fecha');
    if (!fechaInput.value) {
      fechaInput.value = new Date().toISOString().split('T')[0];
    }
  });
</script>
{% endblock %}