<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}ERP{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#f0f8ff',100:'#e6f2ff',200:'#cfe5ff',300:'#a6ceff',
              400:'#6fb0ff',500:'#3a8cff',600:'#1f6fe6',700:'#1a59b8',
              800:'#184d96',900:'#153f78'
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
      <!-- Logo -->
      <div class="h-16 flex items-center px-6 border-b border-slate-200">
        <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center mr-3">
          <span class="text-white font-bold text-xl">E</span>
        </div>
        <span class="text-xl font-bold text-slate-900">ERP</span>
      </div>

      <!-- Selector Empresa -->
      <div class="px-4 py-4 border-b border-slate-200">
        <label class="text-xs font-medium text-slate-500 mb-2 block">EMPRESA ACTIVA</label>
        <select 
          onchange="cambiarEmpresa(this.value)" 
          class="w-full text-sm rounded-lg border border-slate-300 px-3 py-2 bg-white hover:border-brand-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition">
          {% if g.empresas_usuario %}
            {% for emp in g.empresas_usuario %}
            <option value="{{ emp.id }}" {% if emp.id == g.empresa_id %}selected{% endif %}>
              {{ emp.nombre }}
            </option>
            {% endfor %}
          {% else %}
            <option value="{{ g.empresa_id or 1 }}">Empresa actual</option>
          {% endif %}
        </select>
      </div>

      <!-- Navegación -->
      <nav class="flex-1 overflow-y-auto p-4 space-y-1">
        <a href="/dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Dashboard
        </a>

        <!-- Inventarios -->
        <div class="pt-4">
          <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">Inventarios</p>
          <a href="/inventarios/materias_primas" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            Materias Primas
          </a>
          <a href="/inventarios/wip" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            En Proceso (WIP)
          </a>
          <a href="/pt/catalogo" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Productos Terminados
          </a>
        </div>

        <!-- Operaciones -->
        <div class="pt-4">
          <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">Operaciones</p>
          <a href="/nueva_compra" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
            Nueva Compra
          </a>
          <a href="/listado_compras" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Historial Compras
          </a>
          <a href="/production" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Producción
          </a>
        </div>

        <!-- Ventas -->
        <div class="pt-4">
          <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">Ventas</p>
          <a href="/caja" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            Punto de Venta
          </a>
          <a href="/historial_tickets" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Historial Ventas
          </a>
        </div>

        <!-- Configuración -->
        <div class="pt-4">
          <p class="px-3 text-xs font-semibold text-slate-400 uppercase mb-2">Configuración</p>
          <a href="/mercancia" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
            </svg>
            Catálogo SKU
          </a>
        </div>
      </nav>

      <!-- User Info -->
      <div class="p-4 border-t border-slate-200">
        <div class="flex items-center gap-3 mb-3">
          <div class="h-10 w-10 rounded-full bg-brand-100 flex items-center justify-center">
            <span class="text-brand-700 font-semibold text-sm">{{ session.get('username', 'U')[0].upper() }}</span>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-slate-900 truncate">{{ session.get('username', 'Usuario') }}</p>
            <p class="text-xs text-slate-500">{{ session.get('rol', 'admin') }}</p>
          </div>
        </div>
        <a href="/logout" class="flex items-center justify-center gap-2 w-full px-4 py-2 rounded-lg border border-slate-300 text-sm font-medium hover:bg-slate-50 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          Cerrar Sesión
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Topbar -->
      <header class="h-16 bg-white border-b border-slate-200 flex items-center px-6">
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-slate-900">{% block page_title %}{% endblock %}</h2>
        </div>
        <div class="text-sm text-slate-500">
          {{ session.get('username', 'Usuario') }}
        </div>
      </header>

      <!-- Content Area -->
      <main class="flex-1 overflow-y-auto p-6">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-6 space-y-2">
              {% for category, message in messages %}
              <div class="rounded-lg p-4 {% if category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'danger' %}bg-red-50 text-red-800 border border-red-200{% elif category == 'warning' %}bg-amber-50 text-amber-800 border border-amber-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                {{ message }}
              </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Script cambiar empresa -->
  <script>
    function cambiarEmpresa(empresa_id) {
      fetch(`/cambiar-empresa/${empresa_id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(response => {
        if (response.ok) location.reload();
        else alert('Error al cambiar empresa');
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar empresa');
      });
    }
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>