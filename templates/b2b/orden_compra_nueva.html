{% extends "sidebar.html" %}

{% block title %}Nueva Orden de Compra - ERP{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 fw-bold">
                <i class="fas fa-plus-circle text-primary"></i> Nueva Orden de Compra
            </h1>
            <p class="text-muted mb-0">Crear solicitud de mercancía</p>
        </div>
        <a href="{{ url_for('ordenes_compra_b2b') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    <form method="POST" id="formOrden">
        <div class="row">
            <!-- Datos generales -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Datos Generales</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Proveedor *</label>
                            <select name="proveedor_id" class="form-select" required>
                                <option value="">Seleccionar proveedor...</option>
                                {% for p in proveedores %}
                                <option value="{{ p.id }}">{{ p.nombre }}</option>
                                {% endfor %}
                            </select>
                            {% if not proveedores %}
                            <small class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i> 
                                No hay proveedores configurados. 
                                <a href="{{ url_for('relaciones_b2b') }}">Configurar</a>
                            </small>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea name="notas" class="form-control" rows="3" 
                                      placeholder="Observaciones..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> Resumen</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IVA (16%):</span>
                            <span id="iva">$0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Total:</span>
                            <span id="total" class="text-primary">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-boxes"></i> Productos</h5>
                        <button type="button" class="btn btn-sm btn-success" onclick="agregarFila()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="tablaProductos">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 45%;">Producto</th>
                                        <th style="width: 15%;">Cantidad</th>
                                        <th style="width: 15%;">Precio Unit.</th>
                                        <th style="width: 15%;">Importe</th>
                                        <th style="width: 10%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="bodyProductos">
                                    <!-- Filas dinámicas -->
                                </tbody>
                            </table>
                        </div>

                        <div class="text-center py-3" id="sinProductos">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle"></i> 
                                Haz clic en "Agregar Producto" para comenzar
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-primary btn-lg" id="btnGuardar" disabled>
                        <i class="fas fa-save"></i> Guardar Orden
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Datos de productos para JS -->
<script>
const productosDisponibles = [
    {% for p in productos %}
    { id: {{ p.id }}, nombre: "{{ p.nombre }}", precio: {{ p.precio_venta or 0 }}, unidad: "{{ p.unidad_medida or 'pza' }}" },
    {% endfor %}
];

let filaIndex = 0;

function agregarFila() {
    document.getElementById('sinProductos').style.display = 'none';
    
    const tbody = document.getElementById('bodyProductos');
    const tr = document.createElement('tr');
    tr.id = 'fila-' + filaIndex;
    
    let optionsHtml = '<option value="">Seleccionar...</option>';
    productosDisponibles.forEach(p => {
        optionsHtml += `<option value="${p.id}" data-precio="${p.precio}">${p.nombre}</option>`;
    });
    
    tr.innerHTML = `
        <td>
            <select name="producto_id[]" class="form-select form-select-sm" onchange="actualizarPrecio(${filaIndex})" required>
                ${optionsHtml}
            </select>
        </td>
        <td>
            <input type="number" name="cantidad[]" class="form-control form-control-sm" 
                   step="0.01" min="0.01" value="1" onchange="calcularImporte(${filaIndex})" required>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm precio" id="precio-${filaIndex}" readonly>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm importe" id="importe-${filaIndex}" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarFila(${filaIndex})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(tr);
    filaIndex++;
    actualizarBotonGuardar();
}

function actualizarPrecio(idx) {
    const select = document.querySelector(`#fila-${idx} select`);
    const option = select.options[select.selectedIndex];
    const precio = parseFloat(option.dataset.precio || 0);
    
    document.getElementById('precio-' + idx).value = '$' + precio.toFixed(2);
    calcularImporte(idx);
}

function calcularImporte(idx) {
    const select = document.querySelector(`#fila-${idx} select`);
    const option = select.options[select.selectedIndex];
    const precio = parseFloat(option.dataset.precio || 0);
    const cantidad = parseFloat(document.querySelector(`#fila-${idx} input[name="cantidad[]"]`).value) || 0;
    
    const importe = precio * cantidad;
    document.getElementById('importe-' + idx).value = '$' + importe.toFixed(2);
    
    calcularTotales();
}

function eliminarFila(idx) {
    const fila = document.getElementById('fila-' + idx);
    if (fila) {
        fila.remove();
        calcularTotales();
        actualizarBotonGuardar();
        
        if (document.getElementById('bodyProductos').children.length === 0) {
            document.getElementById('sinProductos').style.display = 'block';
        }
    }
}

function calcularTotales() {
    let subtotal = 0;
    
    document.querySelectorAll('.importe').forEach(input => {
        const val = parseFloat(input.value.replace('$', '').replace(',', '')) || 0;
        subtotal += val;
    });
    
    const iva = subtotal * 0.16;
    const total = subtotal + iva;
    
    document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('iva').textContent = '$' + iva.toFixed(2);
    document.getElementById('total').textContent = '$' + total.toFixed(2);
}

function actualizarBotonGuardar() {
    const filas = document.getElementById('bodyProductos').children.length;
    document.getElementById('btnGuardar').disabled = filas === 0;
}

// Agregar primera fila al cargar
document.addEventListener('DOMContentLoaded', function() {
    agregarFila();
});
</script>
{% endblock %}