{% extends "sidebar.html" %}

{% block title %}Factura {{ factura.folio }} - ERP{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 fw-bold">
                <i class="fas fa-file-invoice text-success"></i> {{ factura.folio }}
            </h1>
            <p class="text-muted mb-0">
                {% if es_emisor %}Factura Emitida{% else %}Factura Recibida{% endif %}
            </p>
        </div>
        <div>
            {% if es_emisor %}
            <a href="{{ url_for('facturas_emitidas_b2b') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            {% else %}
            <a href="{{ url_for('facturas_recibidas_b2b') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            {% endif %}
            <button class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimir
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Info Principal -->
        <div class="col-md-8">
            <!-- Encabezado factura -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información</h5>
                    {% if factura.estado == 'emitida' %}
                    <span class="badge bg-primary fs-6">Emitida</span>
                    {% elif factura.estado == 'recibida' %}
                    <span class="badge bg-success fs-6">Entregada</span>
                    {% elif factura.estado == 'con_diferencias' %}
                    <span class="badge bg-danger fs-6">Con Diferencias</span>
                    {% elif factura.estado == 'cancelada' %}
                    <span class="badge bg-danger fs-6">Cancelada</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="text-muted" width="40%">Emisor:</td>
                                    <td class="fw-bold">{{ factura.emisor_nombre }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Receptor:</td>
                                    <td class="fw-bold">{{ factura.receptor_nombre }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Fecha Emisión:</td>
                                    <td>{{ factura.fecha_emision.strftime('%d/%m/%Y %H:%M') if factura.fecha_emision else '-' }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="text-muted" width="40%">Vencimiento:</td>
                                    <td>{{ factura.fecha_vencimiento.strftime('%d/%m/%Y') if factura.fecha_vencimiento else 'Contado' }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Emitida por:</td>
                                    <td>{{ factura.emitida_por_nombre or '-' }}</td>
                                </tr>
                                {% if factura.recibida_por_nombre %}
                                <tr>
                                    <td class="text-muted">Recibida por:</td>
                                    <td>{{ factura.recibida_por_nombre }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalle con checklist -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-list-check"></i> Detalle y Verificación</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">P.Unit</th>
                                    <th class="text-end">Importe</th>
                                    <th class="text-center" title="Almacén Proveedor">
                                        <i class="fas fa-warehouse"></i> Almacén
                                    </th>
                                    <th class="text-center" title="Reparto">
                                        <i class="fas fa-truck"></i> Reparto
                                    </th>
                                    <th class="text-center" title="Almacén Cliente">
                                        <i class="fas fa-clipboard-check"></i> Recepción
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in detalle %}
                                <tr>
                                    <td>
                                        <strong>{{ d.descripcion }}</strong>
                                        {% if d.unidad_medida %}
                                        <br><small class="text-muted">{{ d.unidad_medida }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ d.cantidad_facturada }}</td>
                                    <td class="text-end">${{ '{:,.2f}'.format(d.precio_unitario or 0) }}</td>
                                    <td class="text-end fw-bold">${{ '{:,.2f}'.format(d.importe or 0) }}</td>
                                    
                                    <!-- Check Almacén Proveedor -->
                                    <td class="text-center">
                                        {% if d.verificado_almacen %}
                                        <span class="text-success" title="{{ d.verificado_almacen_por }}">
                                            <i class="fas fa-check-circle fa-lg"></i>
                                        </span>
                                        {% else %}
                                        <span class="text-secondary">
                                            <i class="far fa-circle fa-lg"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Check Reparto -->
                                    <td class="text-center">
                                        {% if d.verificado_reparto %}
                                        <span class="text-success" title="{{ d.verificado_reparto_por }}">
                                            <i class="fas fa-check-circle fa-lg"></i>
                                        </span>
                                        {% else %}
                                        <span class="text-secondary">
                                            <i class="far fa-circle fa-lg"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Check Almacén Cliente -->
                                    <td class="text-center">
                                        {% if d.verificado_cliente %}
                                        <span class="text-success" title="{{ d.verificado_cliente_por }}">
                                            <i class="fas fa-check-circle fa-lg"></i>
                                        </span>
                                        {% else %}
                                        <span class="text-secondary">
                                            <i class="far fa-circle fa-lg"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end">Subtotal:</td>
                                    <td class="text-end">${{ '{:,.2f}'.format(factura.subtotal or 0) }}</td>
                                    <td colspan="3"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">IVA (16%):</td>
                                    <td class="text-end">${{ '{:,.2f}'.format(factura.iva or 0) }}</td>
                                    <td colspan="3"></td>
                                </tr>
                                <tr class="fw-bold">
                                    <td colspan="3" class="text-end">Total:</td>
                                    <td class="text-end text-success fs-5">${{ '{:,.2f}'.format(factura.total or 0) }}</td>
                                    <td colspan="3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel lateral -->
        <div class="col-md-4">
            <!-- Estado del flujo -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Estado del Flujo</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            {% if factura.estado != 'cancelada' %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                            {% else %}
                            <i class="fas fa-times-circle text-danger fa-2x"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong>Factura Emitida</strong>
                            <br><small class="text-muted">{{ factura.fecha_emision.strftime('%d/%m %H:%M') if factura.fecha_emision else '' }}</small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            {% if factura.estado_almacen == 'listo' %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                            {% elif factura.estado_almacen == 'preparando' %}
                            <i class="fas fa-clock text-warning fa-2x"></i>
                            {% else %}
                            <i class="far fa-circle text-secondary fa-2x"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong>Almacén Preparado</strong>
                            <br><small class="text-muted">
                                {% if factura.almacen_completado_fecha %}
                                {{ factura.almacen_completado_fecha.strftime('%d/%m %H:%M') }}
                                {% else %}
                                Pendiente
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            {% if factura.estado_reparto == 'entregado' %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                            {% elif factura.estado_reparto == 'en_camino' %}
                            <i class="fas fa-truck text-info fa-2x"></i>
                            {% else %}
                            <i class="far fa-circle text-secondary fa-2x"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong>En Reparto</strong>
                            <br><small class="text-muted">
                                {% if factura.reparto_entregado_fecha %}
                                {{ factura.reparto_entregado_fecha.strftime('%d/%m %H:%M') }}
                                {% else %}
                                Pendiente
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            {% if factura.estado == 'recibida' %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                            {% else %}
                            <i class="far fa-circle text-secondary fa-2x"></i>
                            {% endif %}
                        </div>
                        <div>
                            <strong>Recibida por Cliente</strong>
                            <br><small class="text-muted">
                                {% if factura.fecha_recepcion %}
                                {{ factura.fecha_recepcion.strftime('%d/%m %H:%M') }}
                                {% else %}
                                Pendiente
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Acciones</h5>
                </div>
                <div class="card-body">
                    {% if es_emisor %}
                        {% if factura.estado_almacen == 'pendiente' %}
                        <a href="{{ url_for('almacen_preparacion_b2b') }}" class="btn btn-warning w-100 mb-2">
                            <i class="fas fa-warehouse"></i> Ir a Preparación
                        </a>
                        {% endif %}
                        
                        {% if factura.estado_almacen == 'listo' and factura.estado_reparto == 'pendiente' %}
                        <a href="{{ url_for('reparto_b2b') }}" class="btn btn-info w-100 mb-2">
                            <i class="fas fa-truck"></i> Ir a Reparto
                        </a>
                        {% endif %}
                    {% else %}
                        {% if factura.estado_entrega == 'pendiente' and factura.estado_reparto == 'en_camino' %}
                        <a href="{{ url_for('recepcion_mercancia_b2b') }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-clipboard-check"></i> Recibir Mercancía
                        </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Historial -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Historial</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% if tracking %}
                    <ul class="list-unstyled mb-0">
                        {% for t in tracking %}
                        <li class="mb-3 pb-2 border-bottom">
                            <div class="d-flex justify-content-between">
                                <strong>{{ t.accion or t.estado_nuevo }}</strong>
                                <small class="text-muted">{{ t.fecha.strftime('%d/%m %H:%M') }}</small>
                            </div>
                            <small class="text-muted">
                                {{ t.usuario_nombre or 'Sistema' }} 
                                {% if t.rol %}({{ t.rol|upper }}){% endif %}
                            </small>
                            {% if t.notas %}
                            <br><small>{{ t.notas }}</small>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted text-center mb-0">Sin historial</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .btn, .card-header, nav, #sidebar { display: none !important; }
    #content { margin-left: 0 !important; }
}
</style>
{% endblock %}