{% extends "sidebar.html" %}
{% block title %}Gestión Usuario-Áreas{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">
        <i class="fas fa-users-cog text-primary"></i> 
        Gestión de Usuarios por Área
      </h3>
      <small class="text-muted">Asigna usuarios a áreas de producción como responsables</small>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Formulario para agregar asignación -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">
        <i class="fas fa-plus-circle"></i> Agregar Nueva Asignación
      </h5>
    </div>
    <div class="card-body">
      <form method="post" action="{{ url_for('admin_usuario_areas_agregar') }}">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Usuario *</label>
            <select class="form-select" name="usuario_id" required>
              <option value="">-- Seleccionar usuario --</option>
              {% for u in usuarios %}
                <option value="{{ u.id }}">
                  {{ u.nombre }} 
                  {% if u.puesto %}({{ u.puesto }}){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Área *</label>
            <select class="form-select" name="area_id" required>
              <option value="">-- Seleccionar área --</option>
              {% for a in areas %}
                <option value="{{ a.id }}">{{ a.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label fw-bold">¿Responsable?</label>
            <select class="form-select" name="es_responsable">
              <option value="1" selected>Sí</option>
              <option value="0">No</option>
            </select>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
              <i class="fas fa-plus"></i> Agregar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de asignaciones -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-list"></i> 
        Asignaciones Actuales ({{ asignaciones|length }})
      </h5>
    </div>
    <div class="card-body p-0">
      {% if asignaciones %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 5%">ID</th>
              <th style="width: 25%">Usuario</th>
              <th style="width: 20%">Puesto</th>
              <th style="width: 20%">Área</th>
              <th class="text-center" style="width: 10%">Responsable</th>
              <th style="width: 10%">Fecha</th>
              <th class="text-center" style="width: 10%">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for asig in asignaciones %}
            <tr>
              <td>{{ asig.id }}</td>
              <td>
                <strong>{{ asig.usuario }}</strong><br>
                <small class="text-muted">{{ asig.correo }}</small>
              </td>
              <td>
                {% if asig.puesto %}
                  <span class="badge bg-info">{{ asig.puesto }}</span>
                {% else %}
                  <span class="text-muted">Sin puesto</span>
                {% endif %}
              </td>
              <td>{{ asig.area }}</td>
              <td class="text-center">
                <form method="post" 
                      action="{{ url_for('admin_usuario_areas_toggle', id=asig.id) }}"
                      style="display: inline;">
                  <button type="submit" 
                          class="btn btn-sm {% if asig.es_responsable %}btn-success{% else %}btn-outline-secondary{% endif %}"
                          title="Click para cambiar">
                    {% if asig.es_responsable %}
                      <i class="fas fa-check-circle"></i> Sí
                    {% else %}
                      <i class="fas fa-times-circle"></i> No
                    {% endif %}
                  </button>
                </form>
              </td>
              <td>
                <small>{{ asig.fecha }}</small>
              </td>
              <td class="text-center">
                <form method="post" 
                      action="{{ url_for('admin_usuario_areas_eliminar', id=asig.id) }}"
                      onsubmit="return confirm('¿Eliminar esta asignación?');"
                      style="display: inline;">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-4 text-center text-muted">
        <i class="fas fa-info-circle fa-3x mb-3"></i>
        <p>No hay asignaciones registradas. Agrega la primera usando el formulario de arriba.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Estadísticas -->
  {% if asignaciones %}
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Total de usuarios asignados</h6>
          <p class="fs-4 mb-0">
            {{ asignaciones|map(attribute='usuario_id')|unique|list|length }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="text-muted">Total de áreas con responsable</h6>
          <p class="fs-4 mb-0">
            {{ asignaciones|selectattr('es_responsable')|map(attribute='area_id')|unique|list|length }}
          </p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}